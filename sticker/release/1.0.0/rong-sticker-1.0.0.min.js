!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.RongSticker=b()}(window,function(){var utils={sha1:function(a){function b(a,b){return a<<b|a>>>32-b}function c(a){var b,c,d="";for(b=7;b>=0;b--)c=a>>>4*b&15,d+=c.toString(16);return d}function d(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}var e,f,g,h,i,j,k,l,m,n=new Array(80),o=1732584193,p=4023233417,q=2562383102,r=271733878,s=3285377520;a=d(a);var t=a.length,u=new Array;for(f=0;f<t-3;f+=4)g=a.charCodeAt(f)<<24|a.charCodeAt(f+1)<<16|a.charCodeAt(f+2)<<8|a.charCodeAt(f+3),u.push(g);switch(t%4){case 0:f=2147483648;break;case 1:f=a.charCodeAt(t-1)<<24|8388608;break;case 2:f=a.charCodeAt(t-2)<<24|a.charCodeAt(t-1)<<16|32768;break;case 3:f=a.charCodeAt(t-3)<<24|a.charCodeAt(t-2)<<16|a.charCodeAt(t-1)<<8|128}for(u.push(f);u.length%16!=14;)u.push(0);for(u.push(t>>>29),u.push(t<<3&4294967295),e=0;e<u.length;e+=16){for(f=0;f<16;f++)n[f]=u[e+f];for(f=16;f<=79;f++)n[f]=b(n[f-3]^n[f-8]^n[f-14]^n[f-16],1);for(h=o,i=p,j=q,k=r,l=s,f=0;f<=19;f++)m=b(h,5)+(i&j|~i&k)+l+n[f]+1518500249&4294967295,l=k,k=j,j=b(i,30),i=h,h=m;for(f=20;f<=39;f++)m=b(h,5)+(i^j^k)+l+n[f]+1859775393&4294967295,l=k,k=j,j=b(i,30),i=h,h=m;for(f=40;f<=59;f++)m=b(h,5)+(i&j|i&k|j&k)+l+n[f]+2400959708&4294967295,l=k,k=j,j=b(i,30),i=h,h=m;for(f=60;f<=79;f++)m=b(h,5)+(i^j^k)+l+n[f]+3395469782&4294967295,l=k,k=j,j=b(i,30),i=h,h=m;o=o+h&4294967295,p=p+i&4294967295,q=q+j&4294967295,r=r+k&4294967295,s=s+l&4294967295}var m=c(o)+c(p)+c(q)+c(r)+c(s);return m.toLowerCase()},tplEngine:function(a,b,c){function d(b){return a.replace(c||/{([^}]+)}/g,function(a,c){return"\\"==a.charAt(0)?a.slice(1):void 0!=b[c]?b[c]:"{"+c+"}"})}"[object Array]"!==Object.prototype.toString.call(b)&&(b=[b]);for(var e=[],f=0,g=b.length;f<g;f++)e.push(d(b[f]));return e.join("")},JSON:function(){var str=function(a,b){var c,d,e,f,g,h=b[a];switch(h&&"object"==typeof h&&"function"==typeof h.toJSON&&(h=h.toJSON(a)),typeof h){case"string":return quote(h);case"number":return isFinite(h)?String(h):"null";case"boolean":case"null":return String(h);case"object":if(!h)return"null";if(g=[],"[object Array]"===Object.prototype.toString.apply(h)){for(f=h.length,c=0;c<f;c+=1)g[c]=str(c,h)||"null";return e=0===g.length?"[]":"["+g.join(",")+"]"}for(d in h)Object.prototype.hasOwnProperty.call(h,d)&&(e=str(d,h))&&g.push(quote(d)+":"+e);return e=0===g.length?"{}":"{"+g.join(",")+"}"}},parse=function(sJSON){return eval("("+sJSON+")")},stringify=function(a){return str("",{"":a})},meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"''":"\\''","\\":"\\\\"},rx_escapable=new RegExp('[\\"\\\\"\0--­؀-؄܏឴឵‌-‏\u2028- ⁠-⁯\ufeff￰-￿]',"g"),quote=function(a){return rx_escapable.lastIndex=0,rx_escapable.test(a)?'"'+a.replace(rx_escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'};return{parse:parse,stringify:stringify}}(),copy:function(a,b){for(var c in b)a[c]=b[c]},noop:function(){},getRandom:function(a){return Math.floor(Math.random()*a)},getTimestamp:function(a){var b=new Date;return a>0&&(b=new Date(a)),b.getTime()},forEach:function(a,b){b=b||RongUtil.noop;var c=function(){for(var c in a)b(a[c],c,a)},d=function(){for(var c=0,d=a.length;c<d;c++)b(a[c],c)};utils.isObject(a)&&c(),utils.isArray(a)&&d()},ajax:function(a){var b=function(){var a=function(){return"undefined"!=typeof XDomainRequest},b=function(){return"undefined"!=typeof XMLHttpRequest};return a()?new XDomainRequest:b()?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},c=b(),d=a.method||"GET",e=a.url,f=a.queryStrings||{},g=[];utils.forEach(f,function(a,b){var c=utils.tplEngine("{key}={value}",{key:b,value:a});g.push(c)});var h=g.join("&");e=utils.tplEngine("{url}?{queryString}",{url:e,queryString:h}),c.open(d,e,!0);var i=a.headers||{};utils.forEach(i,function(a,b){c.setRequestHeader(b,a)});var j=a.success||utils.noop,k=a.fail||utils.noop,l=function(a){return/^(200|202)$/.test(a.code)},m=function(){var a=c.responseText;""!=a&&(a=utils.JSON.parse(c.responseText)),l(a)?j(a):k(a)};"onload"in c?c.onload=m:c.onreadystatechange=function(){4==c.readyState&&m()},c.send(null)},getProtocol:function(){var a=location.protocol;return"file:"==a&&(a="http:"),a},Cache:function(){var a={};this.cache=a,this.set=function(b,c){a[b]=c},this.get=function(b){return a[b]},this.remove=function(b){delete a[b]}},rename:function(a,b){var c=utils.isObject(a);c&&(a=[a]);var d=utils.JSON;a=d.parse(d.stringify(a));var e=function(a,c,d){delete d[c],c=b[c],d[c]=a};return utils.forEach(a,function(a){utils.forEach(a,function(a,c,d){(c in b?e:utils.noop)(a,c,d)})}),c?a[0]:a},isObject:function(a){return"[object Object]"==Object.prototype.toString.call(a)},isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)},isFunction:function(a){return"[object Function]"==Object.prototype.toString.call(a)}},config={appkey:"",url:"stickerservice.ronghub.com"},StickerCache=new utils.Cache,getSignature=function(a){var b=utils.sha1(a.appkey),c=a.nonce,d=a.timestamp,e="{appkey}{nonce}{timestamp}",f=utils.tplEngine(e,{appkey:b,nonce:c,timestamp:d});return utils.sha1(f)},getQueryStrings=function(){var a={appkey:config.appkey,nonce:utils.getRandom(1e4),timestamp:utils.getTimestamp()},b=getSignature(a);return utils.copy(a,{signature:b}),a},getUrl=function(a){var b={"get-sticker":"/emoticonservice/emopkgs/{packageId}/stickers/{stickerId}","get-packages":"/emoticonservice/emopkgs","get-stickers":"/emoticonservice/emopkgs/{packageId}/stickers"},c=b[a.type]||"",d=utils.tplEngine("{protocol}//{host}{path}",{path:c});return utils.copy(a,{protocol:utils.getProtocol(),host:config.url}),utils.tplEngine(d,a)},errorHandler=function(a){var b={1004:{code:1004,msg:"签名错误"},403:{code:403,msg:"AppKey 无效，请移步融云开发者后台获取 AppKey: https://developer.rongcloud.cn/"}},c=b[a.code];return c||(c={code:2e4,msg:a}),c},RequestCache=new utils.Cache,requestProxy=function(a){utils.isFunction(a)&&RequestCache.set("proxy",a)},innerProxy=function(a,b){var c=getUrl(a),d=getQueryStrings();utils.ajax({url:c,queryStrings:d,success:function(a){b(a,null)},fail:function(a){b(null,errorHandler(a))}})};RequestCache.set("proxy",innerProxy);var request=function(a,b){RequestCache.get("proxy")(a,b)},get=function(a,b){var c=a.packageId,d=a.stickerId,e=StickerCache.get(c)||{},f=e[d];if(utils.isObject(f))return utils.copy(f,{packageId:c,stickerId:d}),b(f,null);request({type:"get-sticker",packageId:c,stickerId:d},function(a,c){if(c)return b(a,c);var d=a.data;d=utils.rename(d,{digest:"desc",pkgId:"packageId"}),b(d,c)})},updatePackageCache=function(a){var b=StickerCache.get("packages")||[];a=a.concat(b);var c={};utils.forEach(a,function(a){c[a.id]=a});var d=[];utils.forEach(c,function(a){d.push(a)}),StickerCache.set("packages",d)},updateStickerCache=function(a,b){var c="{id}_list",d=utils.tplEngine(c,{id:a}),e=StickerCache.get(d)||{};utils.forEach(b,function(a){e[a.stickerId]=a}),b.length>0&&(StickerCache.set(d,b),StickerCache.set(a,e))},extend=function(a){if(!utils.isArray(a))throw new Error("Packages must be array");utils.forEach(a,function(a){var b=a.stickers||[];delete a.stickers,updateStickerCache(a.id,b)}),updatePackageCache(a)},getPackages=function(a){a=a||utils.noop,request({type:"get-packages"},function(b,c){if(c)return a(b,c);b=b.data,b=utils.rename(b,{manualLoad:"packages"});var d=b.packages;d=d.concat(b.preload);var e=function(a){return delete a.createTime,delete a.pkgType,a};utils.forEach(d,function(a,b){a=utils.rename(a,{packageId:"id",digest:"desc",cover:"poster",isPreload:"type"}),d[b]=e(a)}),updatePackageCache(d),b={packages:StickerCache.get("packages")},a(b,c)})},getStickers=function(a,b){var c=a.id,d="{id}_list",e=utils.tplEngine(d,{id:c}),f=StickerCache.get(e);if(f)return b({stickers:f},null);request({type:"get-stickers",packageId:c},function(a,d){d&&(a={data:{stickers:[]}});var e=a.data,f=e.stickers;utils.forEach(f,function(a,b){a=utils.rename(a,{digest:"desc"}),utils.copy(a,{packageId:c}),f[b]=a}),updateStickerCache(c,f),a={stickers:f},b(a,d)})},init=function(a){utils.copy(config,a);var b=config.extensions;return utils.isArray(b)&&extend(b),{Sticker:{get:get,getList:getStickers},Package:{getList:getPackages},Proxy:{set:requestProxy},utils:utils}};return{init:init}});